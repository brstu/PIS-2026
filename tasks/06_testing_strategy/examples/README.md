# Testing Strategy ‚Äî Request Service

–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è **Request Service** (–ü–°–û ¬´–Æ–≥–æ-–ó–∞–ø–∞–¥¬ª).

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_request_aggregate.py       # –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã, —Å–æ–±—ã—Ç–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_group_entity.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_value_objects.py
‚îÇ   ‚îî‚îÄ‚îÄ application/
‚îÇ       ‚îú‚îÄ‚îÄ test_create_request_handler.py  # Mock repository
‚îÇ       ‚îî‚îÄ‚îÄ test_query_handlers.py
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ test_request_repository.py          # Testcontainers PostgreSQL
‚îÇ   ‚îî‚îÄ‚îÄ test_event_publisher.py             # RabbitMQ
‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îî‚îÄ‚îÄ test_request_flow.py                # –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π API
‚îî‚îÄ‚îÄ conftest.py                             # Pytest fixtures
```

---

## Test Pyramid

```
      /\
     /E2E\        10% ‚Äî E2E —Ç–µ—Å—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω—ã–µ, —Ö—Ä—É–ø–∫–∏–µ)
    /------\
   /Integration\  20% ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ (–ë–î, API)
  /--------------\
 /  Unit Tests   \ 70% ‚Äî –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ, —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ)
/------------------\
```

---

## –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

### 1. –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (Unit)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- Domain Layer: –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã, —Å–æ–±—ã—Ç–∏—è, –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞
- Application Layer: handlers —Å mock-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `pytest` ‚Äî —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- `unittest.mock` ‚Äî –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ
- `pytest-cov` ‚Äî –ø–æ–∫—Ä—ã—Ç–∏–µ

**–°–∫–æ—Ä–æ—Å—Ç—å:** üöÄ –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)

---

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (Integration)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ (–ë–î, –æ—á–µ—Ä–µ–¥–∏).

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- Repository ‚Üî PostgreSQL
- Event Publisher ‚Üî RabbitMQ
- REST Controller ‚Üî Handlers

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `testcontainers` ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è PostgreSQL –≤ Docker
- `pytest-docker` ‚Äî RabbitMQ –≤ Docker

**–°–∫–æ—Ä–æ—Å—Ç—å:** üê¢ –ú–µ–¥–ª–µ–Ω–Ω–æ (—Å–µ–∫—É–Ω–¥—ã)

---

### 3. E2E-—Ç–µ—Å—Ç—ã (End-to-End)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ—Ä–µ–∑ HTTP API.

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- –ü–æ–ª–Ω—ã–π flow: POST /requests ‚Üí assign group ‚Üí activate ‚Üí GET /requests/{id}

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `fastapi.testclient` ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç
- `playwright` ‚Äî –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°–∫–æ—Ä–æ—Å—Ç—å:** üêå –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ (–¥–µ—Å—è—Ç–∫–∏ —Å–µ–∫—É–Ω–¥)

---

## –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞

### –í—Å–µ —Ç–µ—Å—Ç—ã

```bash
pytest
```

### –¢–æ–ª—å–∫–æ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã

```bash
pytest tests/unit -v
```

### –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º

```bash
pytest --cov=domain --cov=application --cov-report=html
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ (—Ç—Ä–µ–±—É—é—Ç Docker)

```bash
pytest tests/integration -v
```

### E2E

```bash
pytest tests/e2e -v --slow
```

---

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

**–¶–µ–ª—å:** >= 90%

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
pytest --cov=. --cov-report=html

# –û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç
open htmlcov/index.html
```

---

## CI/CD (GitHub Actions)

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: pytest --cov --cov-report=xml
      - uses: codecov/codecov-action@v3
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### ‚úÖ DO

- **–ò–∑–æ–ª–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç—ã** ‚Äî –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º
- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ fixtures** ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ setup/teardown
- **–ù–∞–∑—ã–≤–∞–π—Ç–µ —Ç–µ—Å—Ç—ã –≥–æ–≤–æ—Ä—è—â–∏–º–∏ –∏–º–µ–Ω–∞–º–∏** ‚Äî `test_should_not_activate_without_group`
- **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ edge cases** ‚Äî –≥—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –æ—à–∏–±–∫–∏
- **–ú–æ–∫–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** ‚Äî –≤ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∞—Ö

### ‚ùå DON'T

- **–ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫** ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –ª–æ–≥–∏–∫—É
- **–ù–µ –¥—É–±–ª–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç—ã** ‚Äî –æ–¥–∏–Ω —Ç–µ—Å—Ç –Ω–∞ –æ–¥–∏–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π
- **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ production –ë–î** ‚Äî —Ç–æ–ª—å–∫–æ testcontainers/in-memory
- **–ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –ø–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã** ‚Äî "flaky tests" = —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

---

## Mutation Testing (–±–æ–Ω—É—Å)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤.

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
pip install mutmut

# –ó–∞–ø—É—Å–∫
mutmut run

# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
mutmut show
```

**–û–∂–∏–¥–∞–µ–º–æ–µ:** >= 80% —É–±–∏—Ç—ã—Ö –º—É—Ç–∞–Ω—Ç–æ–≤.
